<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙŠØ§Ø¨Ù„Ø§Ø´ - Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© ÙˆØ§Ù„Ø®ØµÙ…</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --main: #FF8C00; --danger: #e74c3c; --success: #2ecc71; }
        body { font-family: 'Cairo', sans-serif; background: #fdfdfd; margin: 0; text-align: right; }
        .app-bar { background: var(--main); color: white; padding: 15px; text-align: center; font-weight: bold; }
        .card { background: white; margin: 15px; padding: 20px; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }
        .btn { border: none; padding: 12px; border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; }
        .btn-main { background: var(--main); }
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }
        .status-msg { background: #fff3e0; padding: 10px; border-radius: 10px; border: 1px solid var(--main); font-size: 14px; }
        #map { height: 250px; border-radius: 15px; margin: 10px 0; border: 2px solid #eee; }
    </style>
</head>
<body>

<div class="app-bar">ğŸ§¡ ÙŠØ§Ø¨Ù„Ø§Ø´ - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>

<div id="login-view" class="card">
    <input type="tel" id="phoneInput" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" style="width:100%; padding:12px; border-radius:10px; border:1px solid #ddd;">
    <button class="btn btn-main" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
</div>

<div id="role-view" class="hidden card">
    <button class="btn btn-main" onclick="openCustomer()">ğŸ‘¤ Ø£Ù†Ø§ Ø²Ø¨ÙˆÙ†</button>
    <button class="btn btn-success" onclick="openCourier()">ğŸš— Ø£Ù†Ø§ Ù…Ù†Ø¯ÙˆØ¨</button>
</div>

<div id="view-courier" class="hidden">
    <div class="card" id="active-job-card">
        <h4>ğŸ› ï¸ Ø·Ù„Ø¨ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</h4>
        <div id="current-job-info">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø¯ÙŠÙƒ Ø¹Ù…Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹.</div>
    </div>
    <div class="card">
        <h4>ğŸ“¦ Ø³Ø§Ø­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h4>
        <div id="available-orders-list"></div>
    </div>
</div>

<div id="view-tracking" class="hidden card">
    <h4>ğŸ›°ï¸ Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ùƒ</h4>
    <div id="track-status" class="status-msg"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDY9hKoNOaRnUSFzijVtafY2qcb-8pPgAs",
        authDomain: "yabalash-ed0c1.firebaseapp.com",
        projectId: "yabalash-ed0c1",
        storageBucket: "yabalash-ed0c1.firebasestorage.app",
        messagingSenderId: "881656538937",
        appId: "1:881656538937:web:66f7604e638b80427aaae8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let userPhone;

    window.login = () => {
        userPhone = document.getElementById('phoneInput').value;
        if(userPhone.length > 7) {
            localStorage.setItem('phone', userPhone);
            showView('role-view');
        }
    };

    window.openCourier = () => {
        showView('view-courier');
        listenToAvailable();
        listenToCurrentJob();
    };

    // 1. Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨ ÙˆØ®ÙŠØ§Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡ (Ù…Ø¹ Ø§Ù„Ø®ØµÙ…)
    function listenToCurrentJob() {
        const q = query(collection(db, "orders"), where("courier", "==", userPhone), where("status", "==", "accepted"));
        onSnapshot(q, (sn) => {
            const container = document.getElementById('current-job-info');
            if(!sn.empty) {
                const order = sn.docs[0];
                const data = order.data();
                container.innerHTML = `
                    <div style="border: 1px solid #ddd; padding:10px; border-radius:10px;">
                        <b>Ø·Ù„Ø¨ Ù„Ù€:</b> ${data.customer}<br>
                        <b>Ø§Ù„ÙˆØµÙ:</b> ${data.desc}<br>
                        <button class="btn btn-success" onclick="finishOrder('${order.id}')">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… âœ…</button>
                        <button class="btn btn-danger" onclick="rejectAfterAccept('${order.id}')">âŒ Ø¥Ù„ØºØ§Ø¡ (Ø³ÙŠØªÙ… Ø®ØµÙ… 10%)</button>
                    </div>
                `;
            } else {
                container.innerText = "Ø£Ù†Øª Ø­Ø± Ø§Ù„Ø¢Ù†ØŒ ØªØµÙØ­ Ø³Ø§Ø­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª.";
            }
        });
    }

    // 2. ÙˆØ¸ÙŠÙØ© Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„ (Ø§Ù„Ø®ØµÙ… ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø¨)
    window.rejectAfterAccept = async (orderId) => {
        if(confirm("ØªØ­Ø°ÙŠØ±: Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¹Ø¯ Ù‚Ø¨ÙˆÙ„Ù‡ Ø³ÙŠØ¤Ø¯ÙŠ Ù„Ø®ØµÙ… 10% Ù…Ù† Ø±ØµÙŠØ¯Ùƒ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø³Ø§Ø­Ø©. Ù‡Ù„ ØªØªØ§Ø¨Ø¹ØŸ")) {
            try {
                const orderRef = doc(db, "orders", orderId);
                
                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø³Ø§Ø­Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                await updateDoc(orderRef, {
                    status: "pending",
                    courier: null, // Ù…Ø³Ø­ Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ø§Ù„Ø³Ø§Ø¨Ù‚
                    penalty_flag: true // ÙˆØ³Ù… Ù„Ù„Ø®ØµÙ…
                });

                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®ØµÙ… ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ (Ù…Ø­Ø§ÙƒØ§Ø©)
                await addDoc(collection(db, "penalties"), {
                    courier: userPhone,
                    orderId: orderId,
                    amount_ratio: "10%",
                    reason: "Cancel after acceptance",
                    time: serverTimestamp()
                });

                alert("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø¹Ø§Ø¯ØªÙ‡ Ù„Ù„Ø³Ø§Ø­Ø©. ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®ØµÙ… 10% Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ.");
            } catch (e) { alert("Ø®Ø·Ø£: " + e.message); }
        }
    };

    // 3. Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© (Ø§Ù„Ø¬Ù„Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ)
    function listenToAvailable() {
        const q = query(collection(db, "orders"), where("status", "==", "pending"));
        onSnapshot(q, (sn) => {
            const list = document.getElementById('available-orders-list');
            list.innerHTML = "";
            sn.forEach(d => {
                const data = d.data();
                list.innerHTML += `
                    <div class="card" style="border-right: 5px solid var(--main);">
                        <b>Ø§Ù„Ø²Ø¨ÙˆÙ†: ${data.customer}</b><p>${data.desc}</p>
                        <button class="btn btn-main" onclick="acceptOrder('${d.id}')">Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨</button>
                    </div>
                `;
            });
        });
    }

    window.acceptOrder = async (id) => {
        // ÙØ­Øµ Ù‡Ù„ Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ Ù„Ø¯ÙŠÙ‡ Ø·Ù„Ø¨ Ø£ØµÙ„Ø§Ù‹ØŸ
        const checkQ = query(collection(db, "orders"), where("courier", "==", userPhone), where("status", "==", "accepted"));
        // (ØªÙ… ØªØ¨Ø³ÙŠØ·Ù‡Ø§ Ù‡Ù†Ø§ØŒ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ ÙŠÙ…Ù†Ø¹ Ø°Ù„Ùƒ)
        await updateDoc(doc(db, "orders", id), { status: "accepted", courier: userPhone });
    };

    window.finishOrder = async (id) => {
        await updateDoc(doc(db, "orders", id), { status: "completed" });
        alert("Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒØŒ ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©!");
    };

    function showView(id) {
        document.querySelectorAll('body > div:not(.app-bar)').forEach(v => v.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
</script>
</body>
</html>
